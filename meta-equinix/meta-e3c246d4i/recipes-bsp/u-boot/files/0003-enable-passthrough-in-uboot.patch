From eb04103204eae2f00acafe68756e9b986e773233 Mon Sep 17 00:00:00 2001
From: Kuiying Wang <kuiying.wang@intel.com>
Date: Wed, 7 Nov 2018 13:57:57 +0800
Subject: [PATCH 3/3] enable passthrough in uboot

Hacked-for-GPIOD-instead-of-GPIOE-by: Zev Weiss <zweiss@equinix.com>

[0005-enable-passthrough-in-uboot.patch from Intel-BMC.]
---
 arch/arm/mach-aspeed/ast-scu.c | 22 ++++++++++++++++++++++
 board/aspeed/ast-g5/ast-g5.c   |  2 ++
 2 files changed, 24 insertions(+)

diff --git a/arch/arm/mach-aspeed/ast-scu.c b/arch/arm/mach-aspeed/ast-scu.c
index fff02dc0009a..2bec9286b832 100644
--- a/arch/arm/mach-aspeed/ast-scu.c
+++ b/arch/arm/mach-aspeed/ast-scu.c
@@ -544,3 +544,25 @@ void ast_config_uart5_clk(void)
 	ast_scu_write(ast_scu_read(AST_SCU_MISC2_CTRL) &
 				~(1 << 28), AST_SCU_MISC2_CTRL);
 }
+
+
+void ast_enable_pass_through(void)
+{
+	//Enable GPIOE pin mode, SCU90[1] = 0 (disable SD2) */
+	ast_scu_write(ast_scu_read(AST_SCU_FUN_PIN_CTRL5) & (~2),
+		AST_SCU_FUN_PIN_CTRL5);
+
+	//Enable relevant pass through pins by setting SCU8C[11:8] = 0x3.
+	//Pass-through pins set:
+	//GPIOD0 -> GPIOD1
+	//GPIOD2 -> GPIOD3
+	ast_scu_write(ast_scu_read(AST_SCU_FUN_PIN_CTRL4) | (0x300),
+		AST_SCU_FUN_PIN_CTRL4);
+
+	//Disable HWStrap for GPIOD pass-through mode
+	//The write operation to SCU70(0x1e6e2070) only can set to '1'.
+	//To clear to '0', it must write '1' to 0x1e6e207c
+	if (ast_scu_read(AST_SCU_HW_STRAP1) & (0x1 << 21)){
+		ast_scu_write((0x1 << 21), AST_SCU_REVISION_ID);
+	}
+}
diff --git a/board/aspeed/ast-g5/ast-g5.c b/board/aspeed/ast-g5/ast-g5.c
index 5a1fadeedd01..b492003f5110 100644
--- a/board/aspeed/ast-g5/ast-g5.c
+++ b/board/aspeed/ast-g5/ast-g5.c
@@ -20,6 +20,8 @@ int board_early_init_f(void)
 {
 	/* make sure uart5 is using 24MHz clock */
 	ast_config_uart5_clk();
+	/*enable pass through*/
+	ast_enable_pass_through();
 
 	return 0;
 }
-- 
2.7.4

